name: Code Review with Gemini

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  gemini-code-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gemini CLI
        run: |
          # Install Gemini CLI (example installation method)
          npm install -g @google/gemini-cli
          # or pip install gemini-cli depending on the implementation

      - name: Configure Gemini CLI
        run: |
          gemini-cli config set-api-key ${{ secrets.GEMINI_API_KEY }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Analyze code changes with Gemini
        run: |
          for file in ${{ steps.changed-files.outputs.files }}; do
            if [[ $file == *.py ]] || [[ $file == *.js ]] || [[ $file == *.ts ]]; then
              echo "Analyzing $file..."
              gemini-cli generate \
                --prompt "Please review this code for potential issues, bugs, and improvements:" \
                --file "$file" \
                --output "review-$file.md"
            fi
          done

      - name: Post review comments
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Find all review files
            const reviewFiles = execSync('find . -name "review-*.md"').toString().split('\n').filter(f => f);
            
            for (const reviewFile of reviewFiles) {
              if (fs.existsSync(reviewFile)) {
                const review = fs.readFileSync(reviewFile, 'utf8');
                const fileName = reviewFile.replace('./review-', '').replace('.md', '');
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ðŸ¤– Gemini AI Code Review for \`${fileName}\`\n\n${review}`
                });
              }
            }
